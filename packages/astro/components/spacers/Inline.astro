---
import { CSSLength, uid, getSizeValue } from '../../index.ts'
import InlineCluster from './InlineCluster.astro'
import type { InlineProps } from '../types.ts'

function shouldUseSwitch(switchAt?: CSSLength | number) {
	if (switchAt && switchAt > -1) {
		return true
	}

	// TODO: validate the CSSLength
	return typeof switchAt === 'string'
}

const { stretch, switchAt, theme = {}, style = '', ...props } = Astro.props as InlineProps

const maybeSwitchAt = shouldUseSwitch(switchAt)
	? typeof switchAt === 'string'
		? switchAt
		: `${switchAt}px`
	: undefined

const id = uid()

const inlineStyle =
	typeof stretch === 'number' &&
	`
    #${id} > :nth-child(${stretch}) {
        flex: 1;
    }
`

const componentStyle = [
	maybeSwitchAt && `--switchAt: ${maybeSwitchAt}`,
	style
].filter(Boolean).join(';')
---

<InlineCluster
	data-chisel-inline
	{id}
	style={componentStyle}
	data-stretch={typeof stretch === 'string' && stretch}
	{theme}
	{...props}
>
	<slot />
</InlineCluster>

{inlineStyle && (
	<style set:html={inlineStyle}></style>
)}

<style global>
	[data-chisel-inline] {
		flex-wrap: nowrap;
	}
	[data-chisel-inline][data-stretch='all'] > * {
		flex: 1;
	}
	[data-chisel-inline][data-stretch='start'] > :first-child {
		flex: 1;
	}
	[data-chisel-inline][data-stretch='end'] > :last-child {
		flex: 1;
	}
	[data-chisel-inline][style*='--switchAt'] {
		flex-wrap: wrap;
	}
	[data-chisel-inline][style*='--switchAt'] > * {
		min-inline-size: fit-content;
		flex-basis: calc((var(--switchAt) - (100% - var(--gutter, 0px))) * 999);
	}
</style>